name: Notify SDK of new release

on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed

jobs:
  notify-sdk:
    name: Trigger SDK update workflow
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'release' }}
    steps:
      - name: Wait for crates.io propagation
        run: sleep 60

      - name: Get latest release tag
        id: get_tag
        run: |
          TAG=$(curl -s -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/releases/latest | \
            jq -r .tag_name)
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Latest release tag: $TAG"

      - name: Trigger tycho-protocol-sdk update workflow
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.SDK_REPO_DISPATCH_TOKEN }}" \
            https://api.github.com/repos/propeller-heads/tycho-protocol-sdk/dispatches \
            -d '{"event_type":"tycho-execution-release","client_payload":{"version":"${{ steps.get_tag.outputs.tag }}"}}'

      - name: Log notification
        run: |
          echo "Notified tycho-protocol-sdk of release ${{ steps.get_tag.outputs.tag }}"
